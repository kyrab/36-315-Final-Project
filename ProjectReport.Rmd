---
title: "35-315 Final Project Report"
author: "Kyra Balenzano, Evan Feder, David Yuan"
date: "5/2/2020"
output: pdf_document
linestretch: 1.241
fontsize: 12pt
header-includes:
  - \setlength{\parindent}{2em}
  - \usepackage{setspace} \doublespacing
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r message = F, warning = F}
# Load the required libraries
library(tidyverse)
library(pander)
library(gridExtra)
library(wordcloud)
library(tm)
library(ggseas)
library(dendextend)
library(devtools)
#install_github("vqv/ggbiplot")
library(ggbiplot)
```

```{r message = F, warning = F}
spotify <- read.csv("spotify-2000.csv") # Load the data

# Easier column names
colnames(spotify)[1] <- "Index"
colnames(spotify)[6] <- "BPM"
colnames(spotify)[9] <- "Loudness"
colnames(spotify)[12] <- "Duration"

# Cleaning up the genres column
rock <- c("album rock", "alternative metal", "classic rock", "modern rock", 
          "alternative rock", "garage rock", "permanent wave", "modern folk rock",
          "irish rock", "art rock", "celtic rock", "dutch rock", "belgian rock",
          "british invasion", "finnish metal", "dutch metal", "soft rock", "dutch prog",
          "dance rock", "mellow gold", "glam metal", "australian rock", "australian psych",
          "rock-and-roll", "glam rock", "hard rock", "punk", "j-core", "australian
          alternative rock", "yacht rock", "celtic punk", "classic canadian rock",
          "cyberpunk", "classical rock", "christelijk", "canadian rock", "british
          alternative rock", "german alternative rock")
pop <- c("alternative pop rock", "pop", "classic uk pop", "dance pop", "dutch pop",
         "alternative dance", "german pop", "afropop", "disco", "danish pop rock",
         "britpop", "neo mellow", "boy band", "hip pop", "australian pop", "canadian pop",
         "bow pop", "acoustic pop", "candy pop", "operatic pop", "alternative pop",
         "eurodance", "art pop", "uk pop", "brill building pop", "belgian pop",
         "barbadian pop", "chamber pop", "indie pop", "electropop", "folk-pop",
         "metropopolis", "irish pop", "australian dance", "nederpop", "danish pop",
         "italian pop", "la pop", "baroque pop", "austropop", "ccm", "bubblegum pop",
         "europop", "new wave pop", "german pop rock", "levenslied", "classic 
         italian pop", "pop punk")
country <- c("dutch americana", "arkansas country", "british folk", "blues rock",
             "canadian folk", "contemporary country", "australian indie folk", 
             "indie anthem-folk", "australian americana", "classic country pop",
             "folk", "alternative country")
indie <- c("dutch indie", "alaska indie", "icelandic indie")
hip_hop <- c("alternative hip top", "detroit hip hop", "east coast hip hop", 
             "dutch hip hop", "atl hip hop", "g funk", "gangster rap")

findDecade = function(x) {
  ifelse(x >= 1950 && x <= 1969, "1950s-60s", 
    ifelse(x >= 1970 && x <= 1979, "1970s",
      ifelse(x >= 1980 && x <= 1989, "1980s",
        ifelse(x >= 1990 && x <= 1999, "1990s",
          ifelse(x >= 2000 && x <= 2009, "2000s", "2010s")))))
}

findRange = function(x) {
  ifelse(x >= 1950 && x <= 1989, "1950s-1980s", "1990s-2010s")
}

spotify$Decade = sapply(spotify$Year, FUN = findDecade)
spotify$Range = sapply(spotify$Year, FUN = findRange)

spotify = spotify %>%
  mutate(Genre = ifelse(Top.Genre %in% rock, "rock",
                 ifelse(Top.Genre %in% pop, "pop",
                 ifelse(Top.Genre %in% country, "country",
                 ifelse(Top.Genre %in% indie, "indie",
                 ifelse(Top.Genre %in% hip_hop, "hiphop", "other")))))) %>% 
  mutate(Genre = factor(Genre),
         Duration = as.integer(Duration),
         Decade = factor(Decade),
         Range = factor(Range))
```

# Introduction

The "Spotify: All Time Top 2000 Mega Dataset" is a dataset from [Kaggle](https://www.kaggle.com/iamsumat/spotify-top-2000s-mega-dataset) that contains various audio statistics and ratings of the top 1,994 songs on Spotify. For each song, it includes information such as the Title, Artist, Top Genre (a very specific Spotify-labeled genre), Year of release, BPM (beats per minute), and Duration. The first three are nominal categorical variables, Year is an ordinal categorical variable, and the last two are quantitative variables. In addition, for each song, this dataset includes various quantitative ratings, such as those measuring its level of Energy, Danceability, Loudness, Liveness, Valence, Acousticness, Speechiness, and Popularity.

We added additional Genre, Decade, and Decade Range columns so that we could cluster songs into fewer groups, which in turn make visualizations more clear. The Genre column was created by manually sorting the 149 unique Top Genres into six main categories based on trends we saw within the data (Rock, Pop, Country, Hip Hop, Indie, and Other). Because of this anual sorting, there is a possibility of some human bias in results related to genre. Meanwhile, the Decade and Decade Range (two ranges, 1950s-1980s and 1990s-2010s) columns were able to be assembled programmatically.

Using this dataset, we will answer three main questions in our report:

+ Which attributes are associated with which genres?

+ Which attributes do popular songs tend to have?

+ How have the attributes of songs that appear on the top 2000 list changed over time?

# Analysis


## Question 1: Understanding Genre-Specific Attributes



## Question 2: Exploring Popularity

Are you interested in making some popular music? The best way to learn how may be to study the professionals. What qualities do popular songs embody? By taking a look at the correlations between Popularity and other attributes, we can see what these popular songs have in common.

```{r}
#ggpairs()
```


```{r}
correls <- c(-0.00318,0.103,0.144,0.166,-0.122,0.0959,-0.0367,-0.0876,0.112)
names <- c("BPM", "Energy", "Danceability", "Loudness", "Liveness", "Valence", 
           "Duration", "Acousticness", "Speechiness")
kable(t(correls), col.names = names, format = "html") %>% 
  kable_styling(full_width = TRUE)
```

After isolating the correlation coefficient portion of the pairs plot, we can see how correlated Popularity is with the quantitative variables. As the magnitude of all of these correlation coefficients are under 0.2, we can state that Popularity is not associated with any of these quantitative variables.


```{r}
ggplot(spotify, aes(x = Genre, y = Popularity)) + 
  geom_boxplot(fill = "darkgreen") + 
  labs(title = "Popularity across Genres")
```

Taking a look across genre, one clear trend seems to be that indie songs are less popular than those of the other genres. Hip-hop appears to have the highest median popularity across the genres, but with some clear skew left it is hard to judge any clear differences between the non-indie genres.




```{r, warning = FALSE, message = FALSE}
######### ARTIST NAME WORDCLOUD #########
# Big name ==> more popular, can modify to replace artists with song names too

par(mfrow = c(1,2))

# Create split datasets
unpopular <- filter(spotify, spotify$Popularity <= 60)
popular <- filter(spotify, spotify$Popularity > 60)

# Redefine as Corpus
unpop_artists = Corpus(VectorSource(popular$Artist))
pop_artists = Corpus(VectorSource(popular$Artist))

# Remove punctuations
unpop_artists = tm_map(unpop_artists, removePunctuation)
pop_artists = tm_map(pop_artists, removePunctuation)

# Create DTMs
unpop_dtm.artists = DocumentTermMatrix(unpop_artists, control = 
                                         list(stopwords = TRUE))
pop_dtm.artists = DocumentTermMatrix(pop_artists, control = 
                                       list(stopwords = TRUE))

unpop_artists.words = unpop_dtm.artists$dimnames$Terms
unpop_artists.freqs = colSums(as.matrix(unpop_dtm.artists))
pop_artists.words = pop_dtm.artists$dimnames$Terms
pop_artists.freqs = colSums(as.matrix(pop_dtm.artists))


wordcloud(words = unpop_artists.words, freq = unpop_artists.freqs, 
          random.order = FALSE, max.words = 150, colors = 
            brewer.pal(8, "Paired"))
title(main = "Artists of Less Popular Songs")
wordcloud(words = pop_artists.words, freq = pop_artists.freqs, 
          random.order = FALSE, max.words = 150, colors = 
            brewer.pal(8, "Paired"))
title(main = "Artists of More Popular Songs")
```

Above word cloud answers the question: which artists are the most popular? / Do particular artists make songs that are more popular?


## Question 3: Examining Time Trends

Since we have so many quantitative variables, we first tried to condense them into a couple of dimensions and see if there were any changes over those. We performed this dimension reduction using principal component analysis (PCA), plotted the first two dimensions of this result, and then colored the datapoints by the Decade Range variable so that we could make some comparisons regarding time without clouding the graph with too many overlapping colors.

```{r}
######### PCA PLOT #########

# Just include qualitative variables for PCA
spotify.subset = spotify %>% 
  select(-c(Index, Title, Artist, Top.Genre, Year, Genre, Decade, Range))

# From R Demo, Lecture 18:
spotify.center = apply(spotify.subset, MARGIN = 2, FUN = function(x) x - mean(x))
spotify.standard = apply(spotify.center, MARGIN = 2, FUN = function(x) x/sd(x))

spotify.pca = prcomp(spotify.standard, center = TRUE, scale. = TRUE)
```

```{r, fig.align = "center"}
# First two dimensions of PCA
ggbiplot(spotify.pca, ellipse = TRUE, groups = spotify$Range, alpha = 0.5) +
  labs(color = "Decade Range",
       x = "Standardized PC1 (26.3% explained var.)",
       y = "Standardized PC2 (15.2% explained var.)",
       title = "PCA Plot of Quantitative Variables by Decade Range")
```

We can see that Decade Range very vaguely clusters by the first two components, since most of the blue datapoints are above `PC2 = 0` and most of the red datapoints are below it. The direction of the arrow for each attribute indicates how the principal components change as that attribute increases. For example, as BPM increases, PC1 decreases and PC2 increases. (Note: the word `BPM` overlaps with `Liveness`.) Given that the blue cluster is more in that direction, this allows us to conclude that songs from the 1990s-2010s tend to have a greater number of beats per minute than songs from the 1950s-1980s. Similarly, as Duration increases, both PC1 and PC2 increase. This arrow again faces the blue cluster; therefore, we can conclude that songs from the 1990s-2010s tend to be longer than those from the 1950s-1980s. Finally, as Danceability increases, both PC1 and PC2 decrease. Since it is pointing towards the red cluster, this graph suggests that songs from the 1950s-1980s are more danceable than those from the 1990s-2010s.

```{r, results = 'hide'}
t.test(x = spotify.pca$x[spotify$Range == "1950s-1980s", "PC2"],
       y = spotify.pca$x[spotify$Range == "1990s-2010s", "PC2"])
t.test(x = spotify.pca$x[spotify$Range == "1950s-1980s", "PC1"],
       y = spotify.pca$x[spotify$Range == "1990s-2010s", "PC1"])
```

Normal distribution ellipses were drawn on top of the datapoints to visualize the degree by which these clusters differ. 68% of the group's datapoints are contained within each ellipse. Since they overlap quite a bit, especially with respect to PC1, it is questionable whether the principal components, and consequently the quantiative attributes they represent, are significantly different across time/between the two Decade Range groups. In order to more concretely answer this, we can perform a two sample, two-sided T-Test to compare the group means for each of the principal components. The null hypotheses are that the mean PC1 of songs from the 1950s-1980s is equal to the mean PC1 of songs from the 1990s-2010s, and the mean PC2 of songs from the 1950s-1980s is equal to the mean PC1 of songs from the 1990s-2010s. The p-value of the test comparing PC1 group means is $4.623e-07$, while that of PC2 is $<2.2e-16$. So, contrary to what the ellipses might lead us to believe, we are able to conclude that at a level $\alpha = 0.05$, there is enough evidence to reject the null hypotheses that the PC1 group means are equal and the PC2 group means are equal. In conclusion, there are statistically-significant differences in these components when we group datapoints by time categories, but this does not necessarily translate to the quantitative attributes themselves.

```{r, results = 'hide'}
# Here is the proportion of variance accounted by each principal component:
#varProps = summary(spotify.pca)$importance["Proportion of Variance",]
# Draw the line
#plot(1:ncol(spotify.standard), varProps, type = "l",
#     xlab = "Component Number", ylab = "Proportion of Variation")
# Add the points
#points(1:ncol(spotify.standard), varProps, pch = 16)
```

To address some of our qualitative variables, we made a comparison word cloud between the top genres of songs from the 1950s to the 1980s and the top genres of songs from the 1990s to the 2010s to provide insight on how the top genres have changed, if at all, between these two eras.

```{r, warning = FALSE, message = FALSE}
######### COMPARISON WORD CLOUD #########
# Decade range subsets:
early.songs = subset(spotify, Range == "1950s-1980s")
current.songs = subset(spotify, Range == "1990s-2010s")

# Redefine as Corpus (replace "title" with "genre" oops)
title.early = Corpus(VectorSource(early.songs$Top.Genre))
title.current = Corpus(VectorSource(current.songs$Top.Genre))

# Songs from 1950-1980s:
title.early = tm_map(title.early, content_transformer(tolower))
title.early = tm_map(title.early, removePunctuation)
title.early = tm_map(title.early, stripWhitespace)

# Songs from 1990s-2010s:
title.current = tm_map(title.current, content_transformer(tolower))
title.current = tm_map(title.current, removePunctuation)
title.current = tm_map(title.current, stripWhitespace)

# Combine:
titleAll = tm:::c.VCorpus(title.early, title.current)
titleAll = tm_map(titleAll, PlainTextDocument)

# Remove stop words, perform stemming:
titleAll = tm_map(titleAll, removeWords, stopwords("english"))
#titleAll = tm_map(titleAll, stemDocument)

# Term-Document matrix:
tdm.titleAll = TermDocumentMatrix(titleAll, control = list(weighting = weightTfIdf))

# Convert to a matrix class:
tdm.titleAll = as.matrix(tdm.titleAll)

# Comparison calculations:
ne = nrow(early.songs)
nc = nrow(current.songs)

tdm.early.sum = rowSums(tdm.titleAll[, 1:ne])
tdm.current.sum = rowSums(tdm.titleAll[, (ne + 1):(ne + nc)])
tdm.titleAll.sum = cbind(tdm.early.sum, tdm.current.sum)
colnames(tdm.titleAll.sum) = c("1950s-1980s", "1990s-2010s")
```

```{r, warning = FALSE, message = FALSE, fig.align = "center", fig.cap = "Comparison word cloud of Top Genre by Decade Range"}
set.seed(0)

comparison.cloud(tdm.titleAll.sum, random.order = FALSE, rot.per = 0.3,
                 colors = c("turquoise3", "green3"), max.words = 200)
```

In the word cloud, word that are large in size mean that they appear much more on the Decade Range side that they are on (denoted by the labels and colors), while those that are small in size indicate that they appeared roughly an equal number of times betwen the two Decade Ranges. The latter can mean that they only appeared a few times total, or multiple times in both.

```{r, results = 'hide'}
prop.test(c(333, 80), c(864, 1130))
```

Using the above indicators to draw conclusions from our graphic, we can observe that are a few song genres that almost exclusively appeared in the 1950s-1980s, such as "adult standards," "classic rock," "album rock," and "europop." (Note: the word cloud broke a few of these phrases apart.) Meanwhile, "alternative," "modern," and "pop" music seem to be more popular genres in the 1990s-2010s. We can confirm this in one instance using a Chi-Square Test for equal proportions. Suppose we take "album rock"; the null hypothesis is that the proportions of "album rock" songs between the two Decade Range groups are equal. The p-value of this test is $<2.2e-16$. This is significant at a level $\alpha = 0.05$, meaning that there is sufficient evidence to reject the null hypothesis. This test could be done for every genre listed in the word cloud. So, even though we grouped multiple decades together, making us unable to analyze how top genres may or may not have changed decade-to-decade, it is clear that there are some genres that were/are more prominent in one time period or another, including some to a statistically-significant degree, indicating that there was indeed a genre shift over time.

While grouping years into Decade Range categories allows for some insightful graphs, it also makes sense to treat time quantitatively. To that end, to more closely monitor how a single quantitative attribute has changed over time, we constructed a time series plot with decomposition measuring median Danceability. We chose median over mean so that any particular year would not be too adversely affected by outliers, since some years had less songs in this dataset than others.

```{r}
######### SEASONAL DECOMPOSITION #########
average = spotify %>% 
  group_by(Year) %>% 
  dplyr::summarize(avg = median(Danceability))
```

```{r, warning = FALSE, message = FALSE, fig.align = "center"}
ggsdc(data = average, aes(x = Year, y = avg),
      frequency = 5, method = "stl", s.window = 7) +
  geom_line() +
  labs(x = "Year", y = "Median Danceability",
       title = "Seasonal Decomposition Plot of Median Danceability")
```

The global trend can be seen in the second facet, which shows that the median Danceability rating for songs started off rather low, climbed throughout the 1970s, reached a peak around 1980, decreased from the late 1980s and 1990s, and has been steadily increasing since 2000. The seasonal trend can be seen in the third facet: the consistent up-and-down nature of this plot, especially since 1990, suggests that the median Danceability rating follows a cyclical pattern that lasts about five years per cycle. Therefore, the main takeaway from this graph is that not only does Danceability come in big waves over the span of decades, but it also comes in small waves over the span of a few years.

Finally, considering the pattern of Danceability in the previous graph and the genre distributions explored earlier in our report, we were interested in seeing how the number of top songs produced by each genre changed over time. In fact, perhaps these changes over time align with the rise and fall of certain genres.

```{r, warning = FALSE, message = FALSE, fig.align = "center"}
######### STACKED HISTOGRAM #########
ggplot(data = spotify) +
  geom_histogram(aes(x = Year, fill = Genre), color = "black", binwidth = 3) +
  labs(title = "Number of Songs Released per Year by Genre")
```

In general, we can observe that the number of songs released is more or less uniformly distributed, so that has not changed over time. With respect to genre, however, the number of rock songs has decreased since the turn of the century, while the number of pop songs released/on the Top 2000 list has been increasing since about 1975. We can also see that hip-hop music started appearing in the 1990s. These results further validate what we saw in our comparison word cloud graphic. That being said, we are more concerned with its relation to our previous graph. Comparing the two, we see that the rise of pop music occurs at the same time as the first peak in Danceability we saw in the previous graph, while the rise of hip-hop music occurs at the same time as the second cycle/wave. Recall that in our earlier genre analysis graphs, the distribution of Danceability of both pop and hip-hop songs have a left skew. However, it is important to note that these conclusions cannot be interpreted causally.

```{r, results = 'hide'}
######### MULTICOLORED DENSITY CURVE #########

# Also good: Popularity, Valence w/ Range. Mediocre: Energy, Loudness.
# Bad: Liveness, Acousticness, Speechiness, Danceability
#ggplot(data = spotify, aes(x = Duration, color = Decade)) +
#  geom_density(size = 1.25) +
#  labs(color = "Range")
# Interpretation: song duration has changed throughout the decades. All are right skewed
# but 1950s-1960s seemed to have the smallest duration mode, followed by 1970s, 2010s,
# 2000s, 1980s, and then 1990s. Seemed to have cycled around.
```


# Conclusions

Overall, there is not much of a difference between the five genres in terms of the quantiative variables in this dataset, aside from when they tended to be released. While we did observe some minor trends in Energy and Danceability where one or two genres somewhat differentiated themselves from the rest, we could not observe any clear difference between them. We were also able to conclude that Popularity is not associated with any of the other quantitative variables in the dataset. Indie music is less popular than other genres, but there seem to be no significant differences among the rest. Finally, we can conclude that a variety of qualitative and quantitative attributes have appeared to change over time, such as Top Genre and Danceability. Some of these changes are statistically-significant, but others are not.

One limitation to our analysis that we acknowledge is that for the PCA plot, its corresponding scree plot suggested that we should plot the first three dimensions, as the elbow occurred at `k = 3`. However, we did not include it because we were not able to figure out how to both add and interpret the addition of a third dimension. So, our PCA plot is missing some information. In the future, we can research this further so that we can better represent these principal components. Another limitation comes from the data itself; there were many Dutch songs in the dataset even though after a thorough, manual research of their stats, they would not normally appear in a canonical Top 2000 songs listing. So, perhaps these are not truly the Top 2000 songs of all-time, but rather the Top 2000 songs of a Dutch-biased country or person. In the future, we could eliminate those songs entirely, or perhaps even address them more directly.

Additionally, in our future work, we look forward to is exploring these relationships with greater granularity and would be interested in experimenting with various subsets of the data to perform subgroup analyses. *[Explicitly list potential other questions to answer]*
