---
title: "36-315 Final Project"
author: "Kyra Balenzano, Evan Feder, David Yuan"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r message = F, warning = F}
# Load the required libraries
library(tidyverse)
library(pander)
library(gridExtra)
library(wordcloud)
library(tm)
library(ggseas)
library(dendextend)
library(devtools)
# install_github("vqv/ggbiplot")
library(ggbiplot)
library(dplyr)
library(GGally)
```

```{r message = F, warning = F}
spotify <- read.csv("spotify-2000.csv") # Load the data

# Easier column names
colnames(spotify)[1] <- "Index"
colnames(spotify)[6] <- "BPM"
colnames(spotify)[9] <- "Loudness"
colnames(spotify)[12] <- "Duration"

# Cleaning up the genres column
rock <- c("album rock", "alternative metal", "classic rock", "modern rock", 
          "alternative rock", "garage rock", "permanent wave", "modern folk rock",
          "irish rock", "art rock", "celtic rock", "dutch rock", "belgian rock",
          "british invasion", "finnish metal", "dutch metal", "soft rock", "dutch prog",
          "dance rock", "mellow gold", "glam metal", "australian rock", "australian psych",
          "rock-and-roll", "glam rock", "hard rock", "punk", "j-core", "australian
          alternative rock", "yacht rock", "celtic punk", "classic canadian rock",
          "cyberpunk", "classical rock", "christelijk", "canadian rock", "british
          alternative rock", "german alternative rock")
pop <- c("alternative pop rock", "pop", "classic uk pop", "dance pop", "dutch pop",
         "alternative dance", "german pop", "afropop", "disco", "danish pop rock",
         "britpop", "neo mellow", "boy band", "hip pop", "australian pop", "canadian pop",
         "bow pop", "acoustic pop", "candy pop", "operatic pop", "alternative pop",
         "eurodance", "art pop", "uk pop", "brill building pop", "belgian pop",
         "barbadian pop", "chamber pop", "indie pop", "electropop", "folk-pop",
         "metropopolis", "irish pop", "australian dance", "nederpop", "danish pop",
         "italian pop", "la pop", "baroque pop", "austropop", "ccm", "bubblegum pop",
         "europop", "new wave pop", "german pop rock", "levenslied", "classic 
         italian pop", "pop punk")
country <- c("dutch americana", "arkansas country", "british folk", "blues rock",
             "canadian folk", "contemporary country", "australian indie folk", 
             "indie anthem-folk", "australian americana", "classic country pop",
             "folk", "alternative country")
indie <- c("dutch indie", "alaska indie", "icelandic indie")
hip_hop <- c("alternative hip top", "detroit hip hop", "east coast hip hop", 
             "dutch hip hop", "atl hip hop", "g funk", "gangster rap")

findDecade = function(x) {
  ifelse(x >= 1950 && x <= 1969, "1950s-60s", 
    ifelse(x >= 1970 && x <= 1979, "1970s",
      ifelse(x >= 1980 && x <= 1989, "1980s",
        ifelse(x >= 1990 && x <= 1999, "1990s",
          ifelse(x >= 2000 && x <= 2009, "2000s", "2010s")))))
}

findRange = function(x) {
  ifelse(x >= 1950 && x <= 1989, "1950s-1980s", "1990s-2010s")
}

spotify$Decade = sapply(spotify$Year, FUN = findDecade)
spotify$Range = sapply(spotify$Year, FUN = findRange)

spotify = spotify %>%
  mutate(Genre = ifelse(Top.Genre %in% rock, "rock",
                 ifelse(Top.Genre %in% pop, "pop",
                 ifelse(Top.Genre %in% country, "country",
                 ifelse(Top.Genre %in% indie, "indie",
                 ifelse(Top.Genre %in% hip_hop, "hiphop", "other")))))) %>% 
  mutate(Genre = factor(Genre),
         Duration = as.integer(Duration),
         Decade = factor(Decade),
         Range = factor(Range))
```

# Data Description

The "Spotify: All Time Top 2000 Mega Dataset" is a dataset from [Kaggle](https://www.kaggle.com/iamsumat/spotify-top-2000s-mega-dataset) that contains various audio statistics and ratings of the top 1994 songs on Spotify. For each song, it includes information such as the Title, Artist, Year of release, Top Genre, BPM (beats per minute), and Duration. It also includes various ratings, such as those measuring its level of Energy, Danceability, Loudness, Liveness, Valence, Acousticness, Speechiness, and Popularity. We manually added additional Genre, Decade, and Decade Range columns so that we could cluster songs into fewer groups, which will make our analyses more clear.

***
***

# Research Questions

Using our dataset, we would like to answer three main questions:

+ Which attributes are associated with which genres?

+ Which attributes do popular songs tend to have?

+ How have the attributes of songs that appear on the top 2000 list changed over time?

***
***

## Research Question 1: Genres

In order to answer the first research question, we analyzed each quantitative variable by Genre using density plots, then looked at a dendrogram of all of the variables to check if there was any clear difference, and lastly looked at a contour plot of the predictor variables that stood out from the density plots.

### Graph 1

```{r, warning = FALSE}
grid.arrange(
  ggplot(spotify %>% filter(Genre != "other"), aes(x = Energy, fill = Genre)) + 
    geom_density(alpha = 0.3),
  
  ggplot(spotify %>% filter(Genre != "other"), aes(x = Danceability, fill = Genre)) + 
    geom_density(alpha = 0.3),
  
  ggplot(spotify %>% filter(Genre != "other"), aes(x = Popularity, fill = Genre)) + 
    geom_density(alpha = 0.3)
)
```

Of the 10 quantitative variables in this dataset, it seems like only Energy, Danceability, and Popularity show a clear difference between the different overall genres (Note that for the above graphs, we have removed the "other" genre, since it encompasses too many miscellaneous songs and does not provide useful information). Within those three, it seems like country songs tend to have lower Energy than songs of other genres, hip hop songs tend to have higher Danceability than songs of other genres, and indie songs tend to have lower Popularity than songs of other genres. Note, however, that our sample size for the hip hop, indie, and country genres is relatively small, so the conclusions drawn here are not necessarily meaningful.

### Graph 2

```{r, warning = FALSE, message = FALSE}
spotify %>% 
  filter(Genre != "other") %>% 
  select(BPM, Energy, Danceability, Loudness, Liveness, Valence, Duration, 
         Acousticness, Speechiness, Popularity) %>% 
  # select(Energy, Danceability, Popularity) %>% 
  apply(MARGIN = 2, FUN = function(x) x/sd(x)) %>% 
  dist %>% 
  hclust(method = "complete") %>% 
  as.dendrogram %>% 
  set("branches_k_color", k=5) %>% 
  set("labels_colors", order_value = TRUE, 
      ifelse(spotify %>% filter(Genre != "other") %>% pull(Genre) == "country", "brown",
        ifelse(spotify %>% filter(Genre != "other") %>% pull(Genre) == "hiphop", "red",
          ifelse(spotify %>% filter(Genre != "other") %>% pull(Genre) == "indie", "purple",
            ifelse(spotify %>% filter(Genre != "other") %>% pull(Genre) == "pop", "green",
              "blue"))))) %>% 
  plot(main = "Spotify Dendrogram")
```

This dendrogram, made based off of the three variables described above, appears to show very little difference between the five genres. Each of the clusters appears to somewhat similarly distributed. Also, a majority of the data is categorized as `rock`, as our EDA shows.

### Graph 3

```{r, warning = FALSE, message = FALSE}
ggplot(spotify %>% filter(Genre != "other"), aes(x = Energy, y = Danceability)) + 
  geom_point(aes(color = Genre)) + 
  geom_density2d() + 
  labs(title = "Danceability vs. Energy by Genre")
```

Here, we plotted just the predictor variables that appeared to show some variation from the first graph. Again, this graph appears to show very little difference between the genres. There appears to just be one cluster, containing all of the genres somewhat uniformly. Again, this verifies that we have more rock songs than anything else in this dataset.

***

## Research Question 2: Popularity

### Graph 1

### Graph 2

### Graph 3


```{r}
<<<<<<< HEAD
#ggplot(spotify, aes(x = Duration, y = Popularity)) + 
  #geom_point(aes(color = Decade)) + 
  #labs(title = "Popularity and Danceability by Genre")
#ggpairs(data = spotify, columns = 6:15)
model1 <- glm(Popularity ~ BPM + Energy + Danceability + Loudness + Liveness + 
                Valence + Duration +  Acousticness + Speechiness + Genre + 
                Decade, data = spotify, family = gaussian)
model2 <- step(model1, direction = "backward", trace = 0)
summary(model2)
#plot(model2$fitted.values ~ spotify$Popularity)
#abline(0, 1)
=======
# #ggplot(spotify, aes(x = Duration, y = Popularity)) + 
#   #geom_point(aes(color = Decade)) + 
#   #labs(title = "Popularity and Danceability by Genre")
# #ggpairs(data = spotify, columns = 6:15)
# model1 <- glm(Popularity ~ BPM + Energy + Danceability + Loudness + Liveness + 
#                 Valence + Duration +  Acousticness + Speechiness + Genre + 
#                 Decade, data = spotify, family = gaussian)
# model2 <- step(model1, direction = "backward", trace = 0)
# summary(model2)
# #plot(model2$fitted.values ~ spotify$Popularity)
# abline(0, 1)
>>>>>>> 6451633f8e116ec7b1f0550d3d381f5456338000
```

***

## Research Question 3: Time

The third research question mainly concerns itself with time trends. Therefore, we explored various song attributes in the context of the Year, Decade, or Decade Range in which it was released.

### Graph 1

Since our dataset contains so many quantitative variables, we first conducted principal component analysis (PCA). We then made a graph plotting the first two components, and colored our datapoints by the Decade Range variable so that we could make some comparisons regarding time without clouding the graph with too many overlapping colors.

```{r, warning = FALSE, message = FALSE, results = 'hide'}
######### PCA PLOT #########

# Just include qualitative variables for PCA
spotify.subset = spotify %>% 
  select(-c(Index, Title, Artist, Top.Genre, Genre, Decade, Range))

# From R Demo, Lecture 18:
spotify.center = apply(spotify.subset, MARGIN = 2, FUN = function(x) x - mean(x))
spotify.standard = apply(spotify.center, MARGIN = 2, FUN = function(x) x/sd(x))

spotify.pca = prcomp(spotify.standard, center = TRUE, scale. = TRUE)
rotation.pca = as.matrix(spotify.pca$rotation)

# Compute Gamma vectors, which is defined as X \times rotation:
prinComps = as.matrix(spotify.standard) %*% rotation.pca
dim(prinComps)
apply(prinComps, MARGIN = 2, FUN = sd)
```

```{r}
# First two dimensions of PCA
ggbiplot(spotify.pca, groups = spotify$Range, ellipse = TRUE, alpha = 0.5) +
  labs(color = "Decade Range",
       x = "Standardized PC1 (24.2% explained var.)",
       y = "Standardized PC2 (14.5% explained var.)")
```

We can see that Decade Range slightly clusters by the first two principal components, since there are mostly blue datapoints on the top and mostly red datapoints on the bottom. One observation that can be made from this graph is that as BPM increases, PC1 decreases and PC2 increases. Since datapoints from the 1990s-2010s are mostly in this general direction, we can conclude that songs from the 1990s-2010s tend to have a greater number of beats per minute than songs from the 1950s-1980s. That being said, the Normal distribution ellipses overlap quite a bit; as a result, there is not enough evidence to conclude that the two groups are significantly different with respect to their principal components.

### Graph 2

To address some of our quantative variables, we made a comparison word cloud between the top genres of songs from the 1950s to the 1980s and the top genres of songs from the 1990s to the 2010s to provide insight on how the top genres have changed, if at all, between these two eras.

```{r, warning = FALSE, message = FALSE}
######### COMPARISON WORD CLOUD #########
# Decade range subsets:
early.songs = subset(spotify, Range == "1950s-1980s")
current.songs = subset(spotify, Range == "1990s-2010s")

# Redefine as Corpus (replace "title" with "genre" oops)
title.early = Corpus(VectorSource(early.songs$Top.Genre))
title.current = Corpus(VectorSource(current.songs$Top.Genre))

# Songs from 1950-1980s:
title.early = tm_map(title.early, content_transformer(tolower))
title.early = tm_map(title.early, removePunctuation)
title.early = tm_map(title.early, stripWhitespace)

# Songs from 1990s-2010s:
title.current = tm_map(title.current, content_transformer(tolower))
title.current = tm_map(title.current, removePunctuation)
title.current = tm_map(title.current, stripWhitespace)

# Combine:
titleAll = tm:::c.VCorpus(title.early, title.current)
titleAll = tm_map(titleAll, PlainTextDocument)

# Remove stop words, perform stemming:
titleAll = tm_map(titleAll, removeWords, stopwords("english"))
titleAll = tm_map(titleAll, stemDocument)

# Term-Document matrix:
tdm.titleAll = TermDocumentMatrix(titleAll, control = list(weighting = weightTfIdf))

# Convert to a matrix class:
tdm.titleAll = as.matrix(tdm.titleAll)

# Comparison calculations:
ne = nrow(early.songs)
nc = nrow(current.songs)

tdm.early.sum = rowSums(tdm.titleAll[, 1:ne])
tdm.current.sum = rowSums(tdm.titleAll[, (ne + 1):(ne + nc)])
tdm.titleAll.sum = cbind(tdm.early.sum, tdm.current.sum)
colnames(tdm.titleAll.sum) = c("1950s-1980s", "1990s-2010s")
```

```{r, warning = FALSE, message = FALSE}
set.seed(0)

comparison.cloud(tdm.titleAll.sum, random.order = FALSE, rot.per = 0.3,
                 colors = c("blue", "green"), max.words = 200)
```

From this word cloud, there are a few song genres that almost exclusively appeared in the 1950s-1980s, such as "adult standards," "classic rock," "album," and "europop." Meanwhile, "alternative," "modern," and "pop" music seem to be more popular genres in the 1990s-2010s. So, even though we grouped multiple decades together, making us unable to analyze how top genres may or may not have changed decade-to-decade, it is clear that there are some genres that were/are more prominent in one time period or another.

### Graph 3

Finally, to more closely monitor how a single quantitative attribute has changed over time, we constructed a time series plot with decomposition measuring median Danceability.

```{r}
######### TIME SERIES #########
average = spotify %>% 
  group_by(Year) %>% 
  dplyr::summarize(avg = median(Danceability))
```

```{r, warning = FALSE, message = FALSE}
ggsdc(data = average, aes(x = Year, y = avg),
      frequency = 5, method = "stl", s.window = 7) +
  geom_line() +
  labs(x = "Start Date", y = "Median Danceability")
```

The global trend can be seen in the second facet, which shows that the median Danceability rating for songs started off rather low, climbed throughout the 1970s, reached a peak around 1980, decreased from the late 1980s and 1990s, and has been steadily increasing since 2000. The seasonal trend can be seen in the third facet: the consistent up-and-down nature of this plot, especially since 1990, suggests that the median Danceability rating follows a cyclical pattern that lasts about 5 years per cycle. Therefore, the main takeaway from this graph is that not only does Danceability come in big waves over the span of decades, but it also comes in small waves over the span of a few years.

***
***

# Conclusions

Overall, we can conclude that.

In the future, we would like to 

Finally, we can conclude that ...

Overall, there is not much difference between the five genres, in terms of the quantitative variables in this dataset. We did observe some minor trends in Energy, Danceability, and Popularity, where one or two genres were somewhat differentiated from the rest. However, when comparing the five genres using all 11 of the quantitative variables, we could not observe any clear difference between them.

[Second question conclusions]

[Third question conclusions]
