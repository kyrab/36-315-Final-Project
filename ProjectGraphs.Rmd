---
title: "36-315 Final Project"
author: "Kyra Balenzano, Evan Feder, David Yuan"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r message = F, warning = F}
# Load the required libraries
library(tidyverse)
library(pander)
library(gridExtra)
library(wordcloud)
library(tm)
library(ggseas)
library(dendextend)
```

# DATA DESCRIPTION

```{r message = F, warning = F}
spotify <- read.csv("spotify-2000.csv") # Load the data

# Easier column names
colnames(spotify)[1] <- "Index"
colnames(spotify)[6] <- "BPM"
colnames(spotify)[9] <- "Loudness"
colnames(spotify)[12] <- "Duration"

# Cleaning up the genres column
rock <- c("album rock", "alternative metal", "classic rock", "modern rock", 
          "alternative rock", "garage rock", "permanent wave", "modern folk rock",
          "irish rock", "art rock", "celtic rock", "dutch rock", "belgian rock",
          "british invasion", "finnish metal", "dutch metal", "soft rock", "dutch prog",
          "dance rock", "mellow gold", "glam metal", "australian rock", "australian psych",
          "rock-and-roll", "glam rock", "hard rock", "punk", "j-core", "australian
          alternative rock", "yacht rock", "celtic punk", "classic canadian rock",
          "cyberpunk", "classical rock", "christelijk", "canadian rock", "british
          alternative rock", "german alternative rock")
pop <- c("alternative pop rock", "pop", "classic uk pop", "dance pop", "dutch pop",
         "alternative dance", "german pop", "afropop", "disco", "danish pop rock",
         "britpop", "neo mellow", "boy band", "hip pop", "australian pop", "canadian pop",
         "bow pop", "acoustic pop", "candy pop", "operatic pop", "alternative pop",
         "eurodance", "art pop", "uk pop", "brill building pop", "belgian pop",
         "barbadian pop", "chamber pop", "indie pop", "electropop", "folk-pop",
         "metropopolis", "irish pop", "australian dance", "nederpop", "danish pop",
         "italian pop", "la pop", "baroque pop", "austropop", "ccm", "bubblegum pop",
         "europop", "new wave pop", "german pop rock", "levenslied", "classic 
         italian pop", "pop punk")
country <- c("dutch americana", "arkansas country", "british folk", "blues rock",
             "canadian folk", "contemporary country", "australian indie folk", 
             "indie anthem-folk", "australian americana", "classic country pop",
             "folk", "alternative country")
indie <- c("dutch indie", "alaska indie", "icelandic indie")
hip_hop <- c("alternative hip top", "detroit hip hop", "east coast hip hop", 
             "dutch hip hop", "atl hip hop", "g funk", "gangster rap")

findDecade = function(x) {
  ifelse(x >= 1950 && x <= 1969, "1950s-60s", 
    ifelse(x >= 1970 && x <= 1979, "1970s",
      ifelse(x >= 1980 && x <= 1989, "1980s",
        ifelse(x >= 1990 && x <= 1999, "1990s",
          ifelse(x >= 2000 && x <= 2009, "2000s", "2010s")))))
}

findRange = function(x) {
  ifelse(x >= 1950 && x <= 1989, "1950s-1980s", "1990s-2010s")
}

spotify$Decade = sapply(spotify$Year, FUN = findDecade)
spotify$Range = sapply(spotify$Year, FUN = findRange)

spotify = spotify %>%
  mutate(Genre = ifelse(Top.Genre %in% rock, "rock",
                 ifelse(Top.Genre %in% pop, "pop",
                 ifelse(Top.Genre %in% country, "country",
                 ifelse(Top.Genre %in% indie, "indie",
                 ifelse(Top.Genre %in% hip_hop, "hiphop", "other")))))) %>% 
  mutate(Genre = factor(Genre),
         Duration = as.integer(Duration),
         Decade = factor(Decade),
         Range = factor(Range)) %>% 
  select(-Top.Genre)
```

Here's some EDA: 

```{r warning = F, message = F}
# EDA
year.hist = ggplot(spotify, aes(x = Year)) + 
  geom_histogram(fill = "lightblue", color = "black", bins = 20)
bpm.hist = ggplot(spotify, aes(x = BPM)) + 
  geom_histogram(fill = "lightblue", color = "black", bins = 20)
energy.hist = ggplot(spotify, aes(x = Energy)) + 
  geom_histogram(fill = "lightblue", color = "black", bins = 20)
dance.hist = ggplot(spotify, aes(x = Danceability)) + 
  geom_histogram(fill = "lightblue", color = "black", bins = 20)
loud.hist = ggplot(spotify, aes(x = Loudness)) + 
  geom_histogram(fill = "lightblue", color = "black", bins = 20)
live.hist = ggplot(spotify, aes(x = Liveness)) + 
  geom_histogram(fill = "lightblue", color = "black", bins = 20)
val.hist = ggplot(spotify, aes(x = Valence)) + 
  geom_histogram(fill = "lightblue", color = "black", bins = 20)
len.hist = ggplot(spotify, aes(x = Duration)) + 
  geom_histogram(fill = "lightblue", color = "black", bins = 20)
acou.hist = ggplot(spotify, aes(x = Acousticness)) + 
  geom_histogram(fill = "lightblue", color = "black", bins = 20)
speech.hist = ggplot(spotify, aes(x = Speechiness)) + 
  geom_histogram(fill = "lightblue", color = "black", bins = 20)
pop.hist = ggplot(spotify, aes(x = Popularity)) + 
  geom_histogram(fill = "lightblue", color = "black", bins = 20)
genre.bar = ggplot(spotify, aes(x = Genre, fill = Genre)) +
  geom_bar(color = "black") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 90, hjust = 1))

grid.arrange(year.hist, bpm.hist, energy.hist, dance.hist, loud.hist, live.hist,
             val.hist, len.hist, acou.hist, speech.hist, pop.hist, genre.bar, 
             nrow = 4)
```

***
***

# RESEARCH QUESTIONS

+ What attributes are associated with which genres?
  - Facetted histograms
  - Rap songs have more speechiness
  - Few songs have high liveness or acousticness
  - Most songs are loud
  - Valence is uniformly distributed
+ What attributes make a song popular?
  - Plot danceability vs. popularity? Separate by genre?
+ Have the attributes of songs that appear on the top 2000 list changed over time?
  - MDS plot/dendrogram to visualize similarity
  - Comparison word cloud for top genres
  - Time series plot of a particular attribute

***
***

# GRAPHS

## Question 1: Genres

### Graph 1

```{r}
ggplot(spotify %>% filter(Genre != "other"), aes(x = Energy)) + 
  geom_histogram() +
  facet_wrap(~ Genre, ncol = 1)

ggplot(spotify %>% filter(Genre != "other"), aes(x = Danceability)) + 
  geom_histogram() +
  facet_wrap(~ Genre, ncol = 1)

ggplot(spotify %>% filter(Genre != "other"), aes(x = Popularity)) + 
  geom_histogram() +
  facet_wrap(~ Genre, ncol = 1)
```

Of the 10 quantitative variables in this dataset, it seems like only Energy, Danceability, and Popularity show a clear difference between the different genres (Note that for the above graphs, we have removed the "other" genre, since it encompasses too many miscellaneous songs and does not provide useful inforation). Within those three, it seems like country songs tend to have lower Energy than songs of other genres, hip hop songs tend to have higher Danceability than songs of other genres, and indie songs tend to have lower Popularity than songs of other genres. Note, however, that our sample size for the hip hop, indie, and country genres is relatively small, so the conclusions drawn here are not necessarily meaningful.

### Graph 2

```{r}
spotify %>% 
  filter(Genre != "other") %>% 
  select(Energy, Danceability, Popularity) %>% 
  apply(MARGIN = 2, FUN = function(x) x/sd(x)) %>% 
  dist %>% 
  hclust(method = "complete") %>% 
  as.dendrogram %>% 
  set("branches_k_color", k=5) %>% 
  set("labels_colors", order_value = TRUE, 
      ifelse(spotify %>% filter(Genre != "other") %>% pull(Genre) == "country", "brown",
        ifelse(spotify %>% filter(Genre != "other") %>% pull(Genre) == "hiphop", "red",
          ifelse(spotify %>% filter(Genre != "other") %>% pull(Genre) == "indie", "purple",
            ifelse(spotify %>% filter(Genre != "other") %>% pull(Genre) == "pop", "green",
              "blue"))))) %>% 
  plot(main = "Spotify Dendrogram")
```

This dendrogram, made based off of the three variables described above, appears to show very little difference between the five genres. Each of the clusters appears to somewhat similarly distributed. Also, a majority of the data is categorized as `rock`, as our EDA shows.

### Graph 3

```{r}
ggplot(spotify %>% filter(Genre != "other"), aes(x = Popularity, y = Danceability)) + 
  geom_point(aes(color = Genre)) + 
  geom_density2d() + 
  labs(title = "Popularity and Danceability by Genre")
```

Again, this graph appears to show very little difference between the genres. There appears to just be one cluster, containing all of the genres somewhat uniformly. Again, this verifies that we have more rock songs than anything else in this dataset.

***

## Question 2: Popularity

### Graph 1

### Graph 2

### Graph 3

```{r, warning = FALSE, message = FALSE}
######### ARTIST NAME WORDCLOUD #########
# Big name ==> more popular, can modify to replace artists with song names too

# Redefine as Corpus
artists = Corpus(VectorSource(spotify$Artist))

# Remove punctuations
artists = tm_map(artists, removePunctuation)

dtm.artists = DocumentTermMatrix(artists, control = list(stopwords = TRUE))

artists.words = dtm.artists$dimnames$Terms
artists.freqs = colSums(as.matrix(dtm.artists))

wordcloud(words = artists.words, freq = artists.freqs, 
          random.order = FALSE, max.words = 150, colors = brewer.pal(8, "Paired"))
```

***

## Question 3: Time

### Graph 1

### Graph 2

### Graph 3

```{r, warning = FALSE, message = FALSE}
######### MDS PLOT #########

# Just include qualitative variables for MDS
spotify.subset = spotify %>% 
  select(-c(Index, Title, Artist, Top.Genre, Genre, Decade, Range))

spotify.scaled = apply(spotify.subset, MARGIN = 2, FUN = function(x) x/sd(x))
spotify.scaled.dist = dist(spotify.scaled)

mds = cmdscale(d = spotify.scaled.dist, k = 2)
spotify$mds1 = mds[,1]
spotify$mds2 = mds[,2]
```

```{r}
ggplot(data = spotify, aes(x = mds1, y = mds2)) +
  geom_point(aes(color = Range), size = 0.75) +
  labs(x = "MDS Coordinate 1", y = "MDS Coordinate 2",
       title = "MDS Coordinate 2 vs. MDS Coordinate 1")
```

Interpretation: songs from 1990s-2010s have similar qualitative characteristics, and so do songs from 1950s-1980s, since we can see how blue dots are mostly concentrated on the bottom and red dots are mostly concentrated on the top.

```{r, warning = FALSE, message = FALSE}
######### COMPARISON WORD CLOUD #########
# Decade range subsets:
early.songs = subset(spotify, Range == "1950s-1980s")
current.songs = subset(spotify, Range == "1990s-2010s")

# Redefine as Corpus (replace "title" with "genre" oops)
title.early = Corpus(VectorSource(early.songs$Top.Genre))
title.current = Corpus(VectorSource(current.songs$Top.Genre))

# Songs from 1950-1980s:
title.early = tm_map(title.early, content_transformer(tolower))
title.early = tm_map(title.early, removePunctuation)
title.early = tm_map(title.early, stripWhitespace)

# Songs from 1990s-2010s:
title.current = tm_map(title.current, content_transformer(tolower))
title.current = tm_map(title.current, removePunctuation)
title.current = tm_map(title.current, stripWhitespace)

# Combine:
titleAll = tm:::c.VCorpus(title.early, title.current)
titleAll = tm_map(titleAll, PlainTextDocument)

# Remove stop words, perform stemming:
titleAll = tm_map(titleAll, removeWords, stopwords("english"))
titleAll = tm_map(titleAll, stemDocument)

# Term-Document matrix:
tdm.titleAll = TermDocumentMatrix(titleAll, control = list(weighting = weightTfIdf))

# Convert to a matrix class:
tdm.titleAll = as.matrix(tdm.titleAll)

# Comparison calculations:
ne = nrow(early.songs)
nc = nrow(current.songs)

tdm.early.sum = rowSums(tdm.titleAll[, 1:ne])
tdm.current.sum = rowSums(tdm.titleAll[, (ne + 1):(ne + nc)])
tdm.titleAll.sum = cbind(tdm.early.sum, tdm.current.sum)
colnames(tdm.titleAll.sum) = c("1950s-1980s", "1990s-2010s")
```

```{r, warning = FALSE, message = FALSE}
set.seed(0)

comparison.cloud(tdm.titleAll.sum, random.order = FALSE, rot.per = 0.3,
                 colors = c("blue", "green"), max.words = 200)
```

Interpretation: there are a few song genres that almost exclusively appear in the 1950s-1980s, such as "adult standards," "classic rock," "album," and "eurpop." Meanwhile, "alternative," "dutch," "modern," and "pop" music seem to be more popular genres in the era 1990s-2010s. Some genres such as "jazz" are more common in the 1990s-2010s but since it is small, it also appears in the 1950s-1980s a lot.

```{r}
######### MULTICOLORED DENSITY CURVE #########

findRange2 = function(x) {
  ifelse(x == "1950s-60s" || x == "1970s", "1950s-70s",
    ifelse(x == "1980s" || x == "1990s", "1980s-90s", "2000s-10s"))
}

spotify$Range2 = sapply(spotify$Decade, FUN = findRange2)
```

```{r}
# Also good: Popularity, Valence w/ Range. Mediocre: Energy, Loudness.
# Bad: Liveness, Acousticness, Speechiness, Danceability

ggplot(data = spotify, aes(x = Duration, color = Decade)) +
  geom_density(size = 1.25) +
  labs(color = "Range")
```

Interpretation: song duration has changed throughout the decades. All are right skewed but 1950s-1960s seemed to have the smallest duration mode, followed by 1970s, 2010s, 2000s, 1980s, and then 1990s. Seemed to have cycled around.

```{r}
######### TIME SERIES #########
average = spotify %>% 
  group_by(Year) %>% 
  summarize(avg = median(Danceability))
```

```{r, warning = FALSE, message = FALSE}
# Also good: Loudness, Energy, Popularity

ggplot(data = average, aes(x = Year, y = avg)) +
  geom_line(color = "red") +
  stat_rollapplyr(width = 10, align = "right", size = 2, alpha = .4) + 
  labs(title = "Median Danceability vs. Year",
       subtitle = "Width = 10",
       x = "Year", y = "Median Danceability")
```

Interpretation: median danceability comes in waves. From the 1950s-1970s, it was pretty low, but increased from 1980s-1990s, before decreasing again before 2000, and increasing since then.

***
***


# CONCLUSION









